<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –ó–∞–¥–∞—á–∏ ‚Äî TaskFlow</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f5f7;
      font-family: 'Segoe UI', sans-serif;
    }
    .navbar {
      background-color: #0052cc;
    }
    .navbar-brand, .nav-link {
      color: white !important;
    }
    .main-layout {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background-color: #ebecf0;
      padding: 20px 0;
      border-right: 1px solid #ddd;
    }
    .sidebar-item {
      padding: 12px 20px;
      color: #42526e;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .sidebar-item:hover, .sidebar-item.active {
      background-color: #dfe1e6;
      font-weight: 500;
    }
    .main-content {
      flex: 1;
      padding: 30px;
    }
    .page-title {
      font-size: 1.75rem;
      color: #172b4d;
      margin-bottom: 20px;
    }
    .btn-group .btn-check:checked + .btn {
      background-color: #0052cc;
      color: white;
    }
    #kanban-board {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 8px 0;
      min-height: calc(100vh - 200px);
    }
    .kanban-column {
      min-width: 300px;
      max-width: 300px;
      background-color: #ebecf0;
      border-radius: 8px;
      padding: 12px;
    }
    .kanban-column-header {
      font-weight: 600;
      color: #172b4d;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    .kanban-task {
      background: white;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .kanban-task:hover {
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    .kanban-task .task-key {
      font-weight: 600;
      color: #0052cc;
    }
    .kanban-task .task-title {
      font-size: 0.95rem;
      color: #172b4d;
      margin: 4px 0;
    }
    .kanban-task .task-meta {
      font-size: 0.8rem;
      color: #6b778c;
    }
    .priority-critical { border-left: 4px solid #d93f3c; }
    .priority-high { border-left: 4px solid #ffab00; }
    .priority-medium { border-left: 4px solid #0052cc; }
    .priority-low { border-left: 4px solid #00c853; }
  </style>
</head>
<body>
<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/admin/tasks">TaskFlow (–ê–¥–º–∏–Ω)</a>
    <div class="navbar-nav ms-auto">
      <span class="nav-link">–ü—Ä–∏–≤–µ—Ç, <b th:text="${#authentication.principal.userName}">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</b></span>
      <a th:href="@{/logout}" class="nav-link">–í—ã—Ö–æ–¥</a>
    </div>
  </div>
</nav>

<div class="main-layout">
  <!-- –õ–µ–≤–æ–µ –º–µ–Ω—é -->
  <div class="sidebar">
    <div class="sidebar-item active" onclick="switchView('status')">üìã –ü–æ —Å—Ç–∞—Ç—É—Å—É</div>
    <div class="sidebar-item" onclick="switchView('priority')">üî• –ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</div>
    <div class="sidebar-item" onclick="openCreateTaskModal()">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</div>

    <!-- –ê–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏–∏ -->
    <div class="sidebar-item" onclick="openAddDepartmentModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</div>
    <div class="sidebar-item" onclick="openInviteUserModal()">üì® –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
    <div class="sidebar-item" onclick="openAssignUserModal()">üîß –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</div>
    <div class="sidebar-item" onclick="openAssignRoleModal()">üîß –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å –∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</div>

    <hr>
    <div class="sidebar-item" onclick="openCreateProjectModal()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</div>
    <div class="sidebar-item" onclick="openCreateRoleModal()">‚ûï –°–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å</div>
    <div class="sidebar-item" onclick="openAssignmentRulesModal()">üîß –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</div>
    <div class="sidebar-item">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <div class="main-content">
    <h1 class="page-title">–ó–∞–¥–∞—á–∏ (–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å)</h1>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ -->
    <div class="mb-3">
      <div class="btn-group" role="group">
        <input type="radio" class="btn-check" name="viewMode" id="view-status" autocomplete="off" checked>
        <label class="btn btn-outline-primary btn-sm" for="view-status">–ü–æ —Å—Ç–∞—Ç—É—Å—É</label>
        <input type="radio" class="btn-check" name="viewMode" id="view-priority" autocomplete="off">
        <label class="btn btn-outline-primary btn-sm" for="view-priority">–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</label>
      </div>
    </div>

    <!-- Kanban –¥–æ—Å–∫–∞ -->
    <div id="kanban-board"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
          <input type="text" id="taskTitle" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="taskDescription" class="form-control" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <select id="taskPriority" class="form-control">
            <option value="LOW">–ù–∏–∑–∫–∏–π</option>
            <option value="MEDIUM" selected>–°—Ä–µ–¥–Ω–∏–π</option>
            <option value="HIGH">–í—ã—Å–æ–∫–∏–π</option>
            <option value="CRITICAL">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
          <input type="datetime-local" id="taskStart" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
          <input type="datetime-local" id="taskEnd" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
          <select id="taskAssignee" class="form-control" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
          </select>
        </div>
        <!-- –í–´–ë–û–† –ü–†–û–ï–ö–¢–ê -->
        <div class="mb-3">
          <label class="form-label">–ü—Ä–æ–µ–∫—Ç</label>
          <select id="taskProject" class="form-control" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" onclick="createTask()">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç -->
<div class="modal fade" id="createProjectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
          <input type="text" id="projectName" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">–ö–ª—é—á –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: CRM, DEV)</label>
          <input type="text" id="projectKey" class="form-control" required />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-success" onclick="createProject()">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è -->
<div class="modal fade" id="assignmentRulesModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ü—Ä–∞–≤–∏–ª–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–¥–∞—á</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <div class="mb-3 border-bottom pb-3">
          <h6>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</h6>
          <div class="row g-2">
            <div class="col-4">
              <input type="text" id="ruleRoleCode" class="form-control" placeholder="–ö–æ–¥ —Ä–æ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: USER)">
            </div>
            <div class="col-4">
              <input type="text" id="ruleSourceDept" class="form-control" placeholder="–û—Ç–¥–µ–ª –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è">
            </div>
            <div class="col-4">
              <input type="text" id="ruleTargetDept" class="form-control" placeholder="–¶–µ–ª–µ–≤–æ–π –æ—Ç–¥–µ–ª">
            </div>
          </div>
          <div class="mt-2">
            <label class="form-check form-switch">
              <input type="checkbox" id="ruleAllowed" class="form-check-input" checked>
              <span class="form-check-label">–†–∞–∑—Ä–µ—à–µ–Ω–æ</span>
            </label>
          </div>
          <button class="btn btn-sm btn-primary mt-2" onclick="addAssignmentRule()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∞–≤–∏–ª -->
        <table class="table table-sm table-striped">
          <thead>
          <tr>
            <th>–†–æ–ª—å</th>
            <th>–û—Ç–¥–µ–ª (–æ—Ç)</th>
            <th>–û—Ç–¥–µ–ª (–Ω–∞)</th>
            <th>–†–∞–∑—Ä–µ—à–µ–Ω–æ</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
          </thead>
          <tbody id="rulesTableBody">
          <!-- –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å –∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç -->
<div class="modal fade" id="assignRoleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å –∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
          <select id="assignUserSelect" class="form-control" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">–†–æ–ª—å</label>
          <select id="assignRoleSelect" class="form-control" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–µ–π...</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</label>
          <select id="assignDeptSelect" class="form-control" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" onclick="saveUserRole()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –°–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å -->
<div class="modal fade" id="createRoleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–æ–ª—å</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–ö–æ–¥ —Ä–æ–ª–∏</label>
          <input type="text" id="roleCode" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: TEAM_LEAD" required />
        </div>
        <div class="mb-3">
          <label class="form-label">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
          <input type="text" id="roleDisplayName" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –∫–æ–º–∞–Ω–¥—ã" required />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-success" onclick="createRole()">–°–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
<div class="modal fade" id="addDepartmentModal" tabindex="-1"> ... </div>
<div class="modal fade" id="inviteUserModal" tabindex="-1"> ... </div>
<div class="modal fade" id="assignUserModal" tabindex="-1"> ... </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // üî• –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫—É–∫–∏ —Å–µ—Å—Å–∏–∏ (JSESSIONID)
  axios.defaults.withCredentials = true;

  let currentView = 'status';
  let allTasks = [];
  let allUsers = [];
  let allDepartments = [];
  let allAssignmentRules = [];

  // --- –ó–ê–ì–†–£–ó–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ---
  function loadUsers() {
    console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
    axios.get('/api/users/all')
            .then(response => {
              allUsers = response.data;
              console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:', allUsers);

              const select = document.getElementById('taskAssignee');
              if (!select) {
                console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç taskAssignee –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
              }

              select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>';

              if (allUsers.length === 0) {
                select.innerHTML = '<option disabled>–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</option>';
                return;
              }

              allUsers.forEach(user => {
                if (!user.id) {
                  console.warn('‚ö†Ô∏è –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç id:', user);
                  return;
                }

                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.userName || user.email;
                select.appendChild(option);
              });

              console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allUsers.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
            })
            .catch(error => {
              console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –°–º. –∫–æ–Ω—Å–æ–ª—å (F12)');
            });
  }

  // --- –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–ï–ö–¢–û–í ---
  function loadProjects() {
    console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤...');
    axios.get('/project/getAll')
            .then(response => {
              const projects = Array.isArray(response.data) ? response.data : [];
              console.log('‚úÖ –ü—Ä–æ–µ–∫—Ç—ã:', projects);

              const select = document.getElementById('taskProject');
              if (!select) return;

              select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</option>';

              if (projects.length === 0) {
                select.innerHTML = '<option disabled>–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</option>';
                return;
              }

              projects.forEach(project => {
                if (!project.id) return;

                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name} (${project.projectKey})`;
                select.appendChild(option);
              });
            })
            .catch(error => {
              console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error);
            });
  }

  function loadDepartments() {
    axios.get('/api/v1/department/get')
            .then(response => {
              allDepartments = response.data;
            })
            .catch(error => {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤:', error);
            });
  }

  function loadTasks() {
    axios.get('/api/v1/task/getAll')
            .then(response => {
              allTasks = response.data;
              renderKanban();
            })
            .catch(error => {
              alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: ' + (error.response?.data?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            });
  }

  // --- –°–û–ó–î–ê–ù–ò–ï –ó–ê–î–ê–ß–ò ---
  function createTask() {
    const title = document.getElementById('taskTitle').value.trim();
    const start = document.getElementById('taskStart').value;
    const end = document.getElementById('taskEnd').value;
    const assigneeIdStr = document.getElementById('taskAssignee').value;
    const projectIdStr = document.getElementById('taskProject').value;

    console.log("Debug - title:", title);
    console.log("Debug - start:", start);
    console.log("Debug - end:", end);
    console.log("Debug - assigneeIdStr:", assigneeIdStr);
    console.log("Debug - projectIdStr:", projectIdStr);

    if (!title || !start || !end || !assigneeIdStr || !projectIdStr) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è, –≤–∫–ª—é—á–∞—è –ø—Ä–æ–µ–∫—Ç –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è');
      return;
    }

    const assigneeId = parseInt(assigneeIdStr);
    const projectId = parseInt(projectIdStr);

    if (isNaN(assigneeId)) {
      alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å');
      return;
    }

    if (isNaN(projectId)) {
      alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç');
      return;
    }

    if (new Date(end) <= new Date(start)) {
      alert('–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –Ω–∞—á–∞–ª–∞');
      return;
    }

    const dto = {
      title,
      description: document.getElementById('taskDescription').value,
      priority: document.getElementById('taskPriority').value,
      start,
      end,
      assigneeId,
      projectId
    };

    console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é DTO:", dto);

    axios.post('/api/v1/task/create', dto)
            .then(() => {
              alert('‚úÖ –ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
              const modal = bootstrap.Modal.getInstance(document.getElementById('createTaskModal'));
              modal.hide();
              loadTasks();
            })
            .catch(error => {
              console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
              const msg = error.response?.data?.message ||
                      error.response?.data?.error ||
                      '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É';
              alert('‚ùå –û—à–∏–±–∫–∞: ' + msg);
            });
  }

  // --- –°–û–ó–î–ê–ù–ò–ï –ü–†–û–ï–ö–¢–ê ---
  function createProject() {
    const name = document.getElementById('projectName').value.trim();
    const key = document.getElementById('projectKey').value.trim().toUpperCase();

    if (!name || !key) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–ª—é—á –ø—Ä–æ–µ–∫—Ç–∞');
      return;
    }

    axios.post('/project/create', { name, projectKey: key })
            .then(() => {
              alert('‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω!');
              bootstrap.Modal.getInstance(document.getElementById('createProjectModal')).hide();
              loadProjects();
            })
            .catch(error => {
              const msg = error.response?.data?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç';
              alert('‚ùå –û—à–∏–±–∫–∞: ' + msg);
            });
  }

  // --- –ü–†–ê–í–ò–õ–ê –ù–ê–ó–ù–ê–ß–ï–ù–ò–Ø ---
  function openAssignmentRulesModal() {
    loadAssignmentRules();
    new bootstrap.Modal(document.getElementById('assignmentRulesModal')).show();
  }

  function loadAssignmentRules() {
    axios.get('/assignmentRuleService/getAllRoleCompany')
            .then(response => {
              allAssignmentRules = response.data;
              renderAssignmentRules();
            })
            .catch(error => {
              console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤–∏–ª:', error);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞');
            });
  }

  function renderAssignmentRules() {
    const tbody = document.getElementById('rulesTableBody');
    tbody.innerHTML = '';

    if (allAssignmentRules.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">–ù–µ—Ç –ø—Ä–∞–≤–∏–ª</td></tr>';
      return;
    }

    allAssignmentRules.forEach(rule => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${rule.roleName} (${rule.roleCode})</td>
        <td>${rule.sourceDepartment}</td>
        <td>${rule.targetDepartment}</td>
        <td>${rule.allowed ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</td>
        <td>
          <button class="btn btn-sm btn-danger"
                  onclick="deleteAssignmentRule(${rule.id})">
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function addAssignmentRule() {
    const roleCode = document.getElementById('ruleRoleCode').value.trim();
    const sourceDept = document.getElementById('ruleSourceDept').value.trim();
    const targetDept = document.getElementById('ruleTargetDept').value.trim();
    const allowed = document.getElementById('ruleAllowed').checked;

    if (!roleCode || !sourceDept || !targetDept) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }

    const dto = { roleCode, sourceDepartment: sourceDept, targetDepartment: targetDept, allowed };

    axios.post('/assignmentRuleService/add', dto)
            .then(() => {
              alert('‚úÖ –ü—Ä–∞–≤–∏–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
              document.getElementById('ruleRoleCode').value = '';
              document.getElementById('ruleSourceDept').value = '';
              document.getElementById('ruleTargetDept').value = '';
              loadAssignmentRules();
            })
            .catch(error => {
              const msg = error.response?.data?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏';
              alert('‚ùå –û—à–∏–±–∫–∞: ' + msg);
            });
  }

  function deleteAssignmentRule(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ?')) return;

    axios.delete(`/assignmentRuleService/${id}`)
            .then(() => {
              alert('‚úÖ –ü—Ä–∞–≤–∏–ª–æ —É–¥–∞–ª–µ–Ω–æ');
              loadAssignmentRules();
            })
            .catch(error => {
              alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: ' + (error.response?.data?.message || '–û—à–∏–±–∫–∞'));
            });
  }

  // --- –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –†–û–õ–ò –ò –î–ï–ü–ê–†–¢–ê–ú–ï–ù–¢–ê ---
  function openAssignRoleModal() {
    loadUsersForAssignment();
    loadRolesForAssignment();
    loadDepartmentsForAssignment();
    new bootstrap.Modal(document.getElementById('assignRoleModal')).show();
  }

  function loadUsersForAssignment() {
    axios.get('/api/users/all')
            .then(response => {
              const select = document.getElementById('assignUserSelect');
              select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>';
              response.data.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.userName || user.email;
                select.appendChild(option);
              });
            })
            .catch(error => {
              console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            });
  }

  function loadRolesForAssignment() {
    axios.get('/role/all')
            .then(response => {
              const select = document.getElementById('assignRoleSelect');
              select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>';
              response.data.forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code;
                select.appendChild(option);
              });
            })
            .catch(error => {
              console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–ª–µ–π:', error);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–æ–ª–∏');
            });
  }

  function loadDepartmentsForAssignment() {
    axios.get('/api/v1/department/get')
            .then(response => {
              const select = document.getElementById('assignDeptSelect');
              select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</option>';
              response.data.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.textContent = dept.name;
                select.appendChild(option);
              });
            })
            .catch(error => {
              console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤:', error);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã');
            });
  }

  function saveUserRole() {
    const userId = document.getElementById('assignUserSelect').value;
    const roleCode = document.getElementById('assignRoleSelect').value;
    const departmentName = document.getElementById('assignDeptSelect').value;

    if (!userId || !roleCode || !departmentName) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }

    // ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏ —Ä–æ–ª—å, –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
    axios.patch(`/api/v1/department/${userId}/assign-role-and-department`, {
      departmentName: departmentName,
      roleCode: roleCode
    })
            .then(() => {
              alert('‚úÖ –†–æ–ª—å –∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã!');
              bootstrap.Modal.getInstance(document.getElementById('assignRoleModal')).hide();
            })
            .catch(error => {
              const msg = error.response?.data || '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å';
              alert('‚ùå –û—à–∏–±–∫–∞: ' + msg);
            });
  }

  // --- –°–û–ó–î–ê–ù–ò–ï –†–û–õ–ò ---
  function openCreateRoleModal() {
    document.getElementById('roleCode').value = '';
    document.getElementById('roleDisplayName').value = '';
    new bootstrap.Modal(document.getElementById('createRoleModal')).show();
  }

  function createRole() {
    const code = document.getElementById('roleCode').value.trim();
    const displayName = document.getElementById('roleDisplayName').value.trim();

    if (!code || !displayName) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è');
      return;
    }

    const dto = { code, displayName };

    axios.post('/role/add', dto)
            .then(() => {
              alert('‚úÖ –†–æ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
              bootstrap.Modal.getInstance(document.getElementById('createRoleModal')).hide();
              // –û–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–∫–∏ —Ä–æ–ª–µ–π
              loadRolesForAssignment();
            })
            .catch(error => {
              const msg = error.response?.data?.message ||
                      error.response?.data?.error ||
                      '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å';
              alert('‚ùå –û—à–∏–±–∫–∞: ' + msg);
            });
  }

  // --- –†–ï–ù–î–ï–† –î–û–°–ö–ò ---
  function switchView(view) {
    currentView = view;
    document.getElementById('view-' + view).checked = true;
    renderKanban();
  }

  function renderKanban() {
    const container = document.getElementById('kanban-board');
    container.innerHTML = '';

    const groups = currentView === 'status'
            ? { TODO: [], IN_PROGRESS: [], REVIEW: [], DONE: [] }
            : { CRITICAL: [], HIGH: [], MEDIUM: [], LOW: [] };

    const titles = currentView === 'status'
            ? { TODO: '–ù–æ–≤–∞—è', IN_PROGRESS: '–í —Ä–∞–±–æ—Ç–µ', REVIEW: '–ü—Ä–æ–≤–µ—Ä–∫–∞', DONE: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' }
            : { CRITICAL: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π', HIGH: '–í—ã—Å–æ–∫–∏–π', MEDIUM: '–°—Ä–µ–¥–Ω–∏–π', LOW: '–ù–∏–∑–∫–∏–π' };

    allTasks.forEach(task => {
      const key = currentView === 'status' ? task.status : task.priority;
      if (groups[key]) groups[key].push(task);
    });

    Object.keys(groups).forEach(key => {
      const column = document.createElement('div');
      column.className = 'kanban-column';

      const header = document.createElement('div');
      header.className = 'kanban-column-header';
      header.textContent = titles[key];
      column.appendChild(header);

      const taskList = document.createElement('div');
      groups[key].forEach(task => {
        const item = document.createElement('div');
        item.className = `kanban-task priority-${task.priority.toLowerCase()}`;
        item.innerHTML = `
          <div class="task-key">${task.projectKey || 'TASK'}-${task.id}</div>
          <div class="task-title">${task.title}</div>
          <div class="task-meta">
            –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: ${task.assigneeName || '‚Äî'}<br>
            –°—Ä–æ–∫: ${formatDate(task.end)}
          </div>
        `;
        item.onclick = () => openViewTaskModal(task.id);
        taskList.appendChild(item);
      });

      column.appendChild(taskList);
      container.appendChild(column);
    });
  }

  function formatDate(dateStr) {
    return dateStr ? new Date(dateStr).toLocaleDateString('ru-RU') : '‚Äî';
  }

  function openCreateTaskModal() {
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskPriority').value = 'MEDIUM';
    document.getElementById('taskStart').value = '';
    document.getElementById('taskEnd').value = '';
    document.getElementById('taskAssignee').value = '';
    document.getElementById('taskProject').value = '';
    new bootstrap.Modal(document.getElementById('createTaskModal')).show();
  }

  function openViewTaskModal(taskId) {
    alert(`–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á–∏ #${taskId}`);
  }

  function openCreateProjectModal() {
    document.getElementById('projectName').value = '';
    document.getElementById('projectKey').value = '';
    new bootstrap.Modal(document.getElementById('createProjectModal')).show();
  }

  // --- –ó–ê–ì–†–£–ó–ö–ê –ü–†–ò –°–¢–ê–†–¢–ï ---
  document.addEventListener('DOMContentLoaded', () => {
    console.log('‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
    loadUsers();
    loadDepartments();
    loadProjects();
    loadTasks();
  });
</script>
</body>
</html>