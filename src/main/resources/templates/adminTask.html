<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –ó–∞–¥–∞—á–∏ ‚Äî TaskFlow</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f5f7;
      font-family: 'Segoe UI', sans-serif;
    }
    .navbar {
      background-color: #0052cc;
    }
    .navbar-brand, .nav-link {
      color: white !important;
    }
    .main-layout {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background-color: #ebecf0;
      padding: 20px 0;
      border-right: 1px solid #ddd;
    }
    .sidebar-item {
      padding: 12px 20px;
      color: #42526e;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .sidebar-item:hover, .sidebar-item.active {
      background-color: #dfe1e6;
      font-weight: 500;
    }
    .main-content {
      flex: 1;
      padding: 30px;
    }
    .page-title {
      font-size: 1.75rem;
      color: #172b4d;
      margin-bottom: 20px;
    }
    .btn-group .btn-check:checked + .btn {
      background-color: #0052cc;
      color: white;
    }
    #kanban-board {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 8px 0;
      min-height: calc(100vh - 200px);
    }
    .kanban-column {
      min-width: 300px;
      max-width: 300px;
      background-color: #ebecf0;
      border-radius: 8px;
      padding: 12px;
    }
    .kanban-column-header {
      font-weight: 600;
      color: #172b4d;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    .kanban-task {
      background: white;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .kanban-task:hover {
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    .kanban-task .task-key {
      font-weight: 600;
      color: #0052cc;
    }
    .kanban-task .task-title {
      font-size: 0.95rem;
      color: #172b4d;
      margin: 4px 0;
    }
    .kanban-task .task-meta {
      font-size: 0.8rem;
      color: #6b778c;
    }
    .priority-critical { border-left: 4px solid #d93f3c; }
    .priority-high { border-left: 4px solid #ffab00; }
    .priority-medium { border-left: 4px solid #0052cc; }
    .priority-low { border-left: 4px solid #00c853; }
  </style>
</head>
<body>
<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/admin/tasks">TaskFlow (–ê–¥–º–∏–Ω)</a>
    <div class="navbar-nav ms-auto">
      <span class="nav-link">–ü—Ä–∏–≤–µ—Ç, <b th:text="${#authentication.principal.userName}">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</b></span>
      <a th:href="@{/logout}" class="nav-link">–í—ã—Ö–æ–¥</a>
    </div>
  </div>
</nav>

<div class="main-layout">
  <!-- –õ–µ–≤–æ–µ –º–µ–Ω—é (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏) -->
  <div class="sidebar">
    <div class="sidebar-item active" onclick="switchView('status')">üìã –ü–æ —Å—Ç–∞—Ç—É—Å—É</div>
    <div class="sidebar-item" onclick="switchView('priority')">üî• –ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</div>
    <div class="sidebar-item" onclick="openCreateTaskModal()">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</div>

    <!-- –ê–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏–∏ -->
    <div class="sidebar-item" onclick="openAddDepartmentModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</div>
    <div class="sidebar-item" onclick="openInviteUserModal()">üì® –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
    <div class="sidebar-item" onclick="openAssignUserModal()">üîß –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</div>

    <hr>
    <div class="sidebar-item">–ü—Ä–æ–µ–∫—Ç—ã</div>
    <div class="sidebar-item">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <div class="main-content">
    <h1 class="page-title">–ó–∞–¥–∞—á–∏ (–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å)</h1>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ -->
    <div class="mb-3">
      <div class="btn-group" role="group">
        <input type="radio" class="btn-check" name="viewMode" id="view-status" autocomplete="off" checked>
        <label class="btn btn-outline-primary btn-sm" for="view-status">–ü–æ —Å—Ç–∞—Ç—É—Å—É</label>
        <input type="radio" class="btn-check" name="viewMode" id="view-priority" autocomplete="off">
        <label class="btn btn-outline-primary btn-sm" for="view-priority">–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</label>
      </div>
    </div>

    <!-- Kanban –¥–æ—Å–∫–∞ -->
    <div id="kanban-board"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
          <input type="text" id="taskTitle" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="taskDescription" class="form-control" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <select id="taskPriority" class="form-control">
            <option value="LOW">–ù–∏–∑–∫–∏–π</option>
            <option value="MEDIUM" selected>–°—Ä–µ–¥–Ω–∏–π</option>
            <option value="HIGH">–í—ã—Å–æ–∫–∏–π</option>
            <option value="CRITICAL">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
          <input type="datetime-local" id="taskStart" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
          <input type="datetime-local" id="taskEnd" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
          <select id="taskAssignee" class="form-control" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</label>
          <select id="taskDepartment" class="form-control" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" onclick="createTask()">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –¥–æ–±–∞–≤–∏—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç -->
<div class="modal fade" id="addDepartmentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞</label>
          <input type="text" id="departmentName" class="form-control" required />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" onclick="addDepartment()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="modal fade" id="inviteUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" id="inviteEmail" class="form-control" required />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" onclick="inviteUser()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç -->
<div class="modal fade" id="assignUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)</label>
          <select id="userSelect" class="form-control" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</label>
          <select id="departmentSelect" class="form-control" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" onclick="assignUserToDepartment()">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  let currentView = 'status';
  let allTasks = [];
  let allUsers = [];
  let allDepartments = [];

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  function loadUsers() {
    axios.get('/api/users/all')
            .then(response => {
              allUsers = response.data;
              const select = document.getElementById('taskAssignee');
              select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>';
              allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.userName || user.email;
                select.appendChild(option);
              });
            })
            .catch(error => {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            });
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤
  function loadDepartments() {
    axios.get('/api/v1/department/get')
            .then(response => {
              allDepartments = response.data;
              const select = document.getElementById('taskDepartment');
              select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</option>';
              allDepartments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                select.appendChild(option);
              });
            })
            .catch(error => {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤:', error);
            });
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∞
  function switchView(view) {
    currentView = view;
    document.getElementById('view-' + view).checked = true;
    renderKanban();
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
  function loadTasks() {
    axios.get('/api/v1/task/getAll')
            .then(response => {
              allTasks = response.data;
              renderKanban();
            })
            .catch(error => {
              alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: ' + (error.response?.data || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            });
  }

  // –†–µ–Ω–¥–µ—Ä Kanban
  function renderKanban() {
    const container = document.getElementById('kanban-board');
    container.innerHTML = '';

    let groups = {};
    let titles = {};

    if (currentView === 'status') {
      groups = { TODO: [], IN_PROGRESS: [], REVIEW: [], DONE: [] };
      titles = {
        TODO: '–ù–æ–≤–∞—è',
        IN_PROGRESS: '–í —Ä–∞–±–æ—Ç–µ',
        REVIEW: '–ü—Ä–æ–≤–µ—Ä–∫–∞',
        DONE: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
      };
    } else {
      groups = { CRITICAL: [], HIGH: [], MEDIUM: [], LOW: [] };
      titles = {
        CRITICAL: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π',
        HIGH: '–í—ã—Å–æ–∫–∏–π',
        MEDIUM: '–°—Ä–µ–¥–Ω–∏–π',
        LOW: '–ù–∏–∑–∫–∏–π'
      };
    }

    allTasks.forEach(task => {
      const key = currentView === 'status' ? task.status : task.priority;
      if (groups[key]) {
        groups[key].push(task);
      }
    });

    Object.keys(groups).forEach(key => {
      const column = document.createElement('div');
      column.className = 'kanban-column';

      const header = document.createElement('div');
      header.className = 'kanban-column-header';
      header.textContent = titles[key];
      column.appendChild(header);

      const taskList = document.createElement('div');

      groups[key].forEach(task => {
        const item = document.createElement('div');
        item.className = `kanban-task ${getPriorityClass(task.priority)}`;
        item.innerHTML = `
                    <div class="task-key">${task.projectKey || 'TASK'}-${task.id}</div>
                    <div class="task-title">${task.title}</div>
                    <div class="task-meta">
                        –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: ${task.assigneeName || '‚Äî'}<br>
                        –°—Ä–æ–∫: ${formatDate(task.end)}
                    </div>
                `;
        item.onclick = () => openViewTaskModal(task.id);
        taskList.appendChild(item);
      });

      column.appendChild(taskList);
      container.appendChild(column);
    });
  }

  function getPriorityClass(priority) {
    switch (priority) {
      case 'CRITICAL': return 'priority-critical';
      case 'HIGH': return 'priority-high';
      case 'MEDIUM': return 'priority-medium';
      case 'LOW': return 'priority-low';
      default: return 'priority-medium';
    }
  }

  function formatDate(dateStr) {
    if (!dateStr) return '‚Äî';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ru-RU');
  }

  // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
  function openCreateTaskModal() {
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskPriority').value = 'MEDIUM';
    document.getElementById('taskStart').value = '';
    document.getElementById('taskEnd').value = '';
    document.getElementById('taskAssignee').value = '';
    document.getElementById('taskDepartment').value = '';
    new bootstrap.Modal(document.getElementById('createTaskModal')).show();
  }

  // –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
  function createTask() {
    const title = document.getElementById('taskTitle').value;
    const start = document.getElementById('taskStart').value;
    const end = document.getElementById('taskEnd').value;
    const assigneeId = document.getElementById('taskAssignee').value;
    const departmentId = document.getElementById('taskDepartment').value;

    if (!title || !start || !end || !assigneeId || !departmentId) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }
    if (new Date(end) <= new Date(start)) {
      alert('–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –Ω–∞—á–∞–ª–∞');
      return;
    }

    const dto = {
      title: title,
      description: document.getElementById('taskDescription').value,
      priority: document.getElementById('taskPriority').value,
      start: start,
      end: end,
      assigneeId: parseInt(assigneeId),
      departmentId: parseInt(departmentId)
    };

    axios.post('/api/v1/task/create', dto)
            .then(response => {
              alert('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞!');
              bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();
              loadTasks();
            })
            .catch(error => {
              const msg = error.response?.data?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É';
              alert('–û—à–∏–±–∫–∞: ' + msg);
            });
  }

  // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
  function openAddDepartmentModal() {
    document.getElementById('departmentName').value = '';
    new bootstrap.Modal(document.getElementById('addDepartmentModal')).show();
  }

  // –î–æ–±–∞–≤–∏—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç
  function addDepartment() {
    const name = document.getElementById('departmentName').value.trim();
    if (!name) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞');
      return;
    }

    axios.post('/api/v1/department/addDepartment', { name: name })
            .then(response => {
              alert('–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
              bootstrap.Modal.getInstance(document.getElementById('addDepartmentModal')).hide();
              loadDepartments();
            })
            .catch(error => {
              const msg = error.response?.data?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç';
              alert('–û—à–∏–±–∫–∞: ' + msg);
            });
  }

  // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
  function openInviteUserModal() {
    document.getElementById('inviteEmail').value = '';
    new bootstrap.Modal(document.getElementById('inviteUserModal')).show();
  }

  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
  function inviteUser() {
    const email = document.getElementById('inviteEmail').value.trim();
    if (!email) {
      alert('–í–≤–µ–¥–∏—Ç–µ email');
      return;
    }

    axios.post('/InvitationToken/addInvitationToken', null, {
      params: { email: email }
    })
            .then(response => {
              alert('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
              bootstrap.Modal.getInstance(document.getElementById('inviteUserModal')).hide();
            })
            .catch(error => {
              const msg = error.response?.data || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ';
              alert('–û—à–∏–±–∫–∞: ' + msg);
            });
  }

  // --- –ù–û–í–û–ï: –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç ---
  function openAssignUserModal() {
    const userSelect = document.getElementById('userSelect');
    const deptSelect = document.getElementById('departmentSelect');

    userSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</option>';
    deptSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤...</option>';

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á—Ç–æ–±—ã –≤–∑—è—Ç—å companyId)
    axios.get('/api/users/me')
            .then(meResponse => {
              const companyId = meResponse.data.companyId;

              // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
              return axios.get(`/api/users/${companyId}/awaiting`)
                      .then(usersResponse => {
                        const awaitingUsers = usersResponse.data;
                        userSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>';
                        awaitingUsers.forEach(user => {
                          const option = document.createElement('option');
                          option.value = user.id;
                          option.textContent = `${user.userName || user.email} (${user.roleCode})`;
                          userSelect.appendChild(option);
                        });
                      });
            })
            .catch(err => {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', err);
              userSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã
    axios.get('/api/v1/department/get')
            .then(response => {
              allDepartments = response.data;
              deptSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</option>';
              allDepartments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                deptSelect.appendChild(option);
              });
            })
            .catch(err => {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤:', err);
              deptSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã');
            });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    new bootstrap.Modal(document.getElementById('assignUserModal')).show();
  }

  function assignUserToDepartment() {
    const userId = document.getElementById('userSelect').value;
    const departmentId = document.getElementById('departmentSelect').value;

    if (!userId || !departmentId) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç');
      return;
    }

    axios.patch(`/api/v1/department/${userId}/assign-to/${departmentId}`)
            .then(() => {
              alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω –≤ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç!');
              bootstrap.Modal.getInstance(document.getElementById('assignUserModal')).hide();
            })
            .catch(error => {
              const msg = error.response?.data?.message || error.response?.data || '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å';
              alert('–û—à–∏–±–∫–∞: ' + msg);
            });
  }

  // –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á–∏ (–∑–∞–≥–ª—É—à–∫–∞)
  function openViewTaskModal(taskId) {
    alert(`–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á–∏ #${taskId}`);
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  document.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    loadDepartments();
    loadTasks();
  });
</script>
</body>
</html>